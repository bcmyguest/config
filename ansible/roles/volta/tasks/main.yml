- name: get latest release of volta
  community.general.github_release:
    user: volta-cli
    repo: volta
    action: latest_release
    prerelease: false
  register: release
- name: extract version from release
  set_fact:
    current_release: "{{ release.tag | regex_search('([0-9]+\\.[0-9]+\\.[0-9]+)', multiline=True) }}"
  check_mode: false
  when:
    - release is succeeded 


- name: get current version
  ansible.builtin.command:
    argv:
      - volta
      - --version
  register: current_version
  ignore_errors: true
  changed_when: false
  check_mode: false

- name: extract version
  set_fact:
    current_version: "{{ current_version.stdout_lines[0] | regex_search('([0-9]+\\.[0-9]+\\.[0-9]+)', multiline=True) }}"
  check_mode: false
  when:
    - current_version is succeeded and current_version.stdout_lines is defined

- name: extract version
  set_fact:
    current_version: "v{{ current_version }}"
  check_mode: false

- name: Show current version
  debug:
    var: current_version
  when:
    - current_version.rc is not defined

- name: latest release
  debug:
    var: release.tag

- name: pinned version
  debug:
    var: pinned_version

# should be either release.tag or neovim_pinned_version
- name: set version to install
  set_fact:
    version_to_install: "{{ release.tag }}"
  when:
    - pinned_version is not defined

- name: set version to install
  set_fact:
    version_to_install: "{{ pinned_version }}"
  when:
    - pinned_version is defined

- name: Show version to install
  debug:
    var: version_to_install
- name: Installed correct version
  debug:
    var: version_to_install != current_version
- name: extract binary
  ansible.builtin.unarchive:
    src:  "https://github.com/volta-cli/volta/releases/download/{{release.tag}}/volta-2.0.2-linux.tar.gz"
    dest: "{{ ansible_env.HOME }}/.local/bin"
    mode: "0755"
    remote_src: true
  when:
    - not ansible_check_mode
    - version_to_install != current_version

- name: Change volta-migrate owner
  file:
    path: "{{ ansible_env.HOME }}/.local/bin/volta-migrate"
    state: file 
    recurse: false
    owner: 1000
    group: 1000
- name: Change volta-shim owner
  file:
    path: "{{ ansible_env.HOME }}/.local/bin/volta-shim"
    state: file 
    recurse: false
    owner: 1000
    group: 1000
- name: Change volta owner
  file:
    path: "{{ ansible_env.HOME }}/.local/bin/volta"
    state: file 
    recurse: false
    owner: 1000
    group: 1000


- name: add volta to PATH
  ansible.builtin.shell:
    cmd: 'export PATH=$PATH:{{ extra_path }}'
